name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore GitHelper/GitHelper.csproj
      
    - name: Build and Publish
      run: |
        dotnet publish GitHelper/GitHelper.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:PublishTrimmed=false `
          -o ./publish
      
    - name: Create Release Package
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path ./release
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item ./publish/GitHelper.exe ./release/
        
        # å¤åˆ¶å›¾æ ‡èµ„æº
        if (Test-Path ./GitHelper/Resources) {
          New-Item -ItemType Directory -Force -Path ./release/Resources
          Copy-Item ./GitHelper/Resources/* ./release/Resources/
        }
        
        # åˆ›å»ºç®€å•è¯´æ˜æ–‡ä»¶
        @"
        Git å¿«æ·åŠ©æ‰‹ v${{ github.ref_name }}
        
        ä½¿ç”¨æ–¹æ³•ï¼š
        1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
        2. åŒå‡» GitHelper.exe è¿è¡Œ
        3. é€‰æ‹©è¦ç®¡ç†çš„é¡¹ç›®æ–‡ä»¶å¤¹
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10/11 (64-bit)
        - å·²è‡ªå¸¦ .NET è¿è¡Œæ—¶ï¼Œæ— éœ€é¢å¤–å®‰è£…
        
        å®Œæ•´æ–‡æ¡£ï¼šhttps://github.com/zczy-k/githelper
        "@ | Out-File -FilePath ./release/ä½¿ç”¨è¯´æ˜.txt -Encoding UTF8
        
        # æ‰“åŒ…æˆ ZIP
        Compress-Archive -Path ./release/* -DestinationPath GitHelper-${{ github.ref_name }}-win-x64.zip
        
    - name: Extract version info
      id: version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          GitHelper-${{ github.ref_name }}-win-x64.zip
        body: |
          ## ğŸ‰ Git å¿«æ·åŠ©æ‰‹ ${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½
          ä¸‹è½½ `GitHelper-${{ github.ref_name }}-win-x64.zip` å¹¶è§£å‹å³å¯ä½¿ç”¨ã€‚
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¯ ç®€å•æ˜“ç”¨çš„ Git å›¾å½¢åŒ–ç®¡ç†
          - ğŸ“ æ™ºèƒ½ç›®å½•å†å²è®°å¿†
          - â° è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
          - ğŸ”” ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ
          
          ### ğŸ’¾ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64-bit)
          - å·²è‡ªå¸¦è¿è¡Œæ—¶ï¼Œæ— éœ€å®‰è£…å…¶ä»–ä¾èµ–
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
          2. åŒå‡» `GitHelper.exe` è¿è¡Œ
          3. é€‰æ‹©è¦ç®¡ç†çš„é¡¹ç›®æ–‡ä»¶å¤¹
          4. å¼€å§‹ä½¿ç”¨ï¼
          
          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [README.md](https://github.com/zczy-k/githelper/blob/main/README.md)
          
          ---
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          <!-- åœ¨è¿™é‡Œæ‰‹åŠ¨æ·»åŠ æ›´æ–°æ—¥å¿— -->
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
